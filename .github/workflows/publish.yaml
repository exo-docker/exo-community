name: Build, Sign, and Publish Docker Image

on:
  push:
    tags:
      - "[7-9].[0-9]+.[0-9]+"

concurrency:
  group: docker-publish-${{ github.ref }}
  cancel-in-progress: false

jobs:
  parse-docker-build-env:
    name: "Parse Docker Build Environment"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.detect-push-event.outputs.image_tag }}
    steps:
      - name: Extract tag from ref
        id: detect-push-event
        run: |
          if [[ "${GITHUB_REF}" =~ ^refs/tags/(.+)$ ]]; then
            TAG="${BASH_REMATCH[1]}"
            echo "Detected tag push: ${TAG}"
            echo "image_tag=${TAG}" >> "${GITHUB_OUTPUT}"
          else
            echo "Unsupported ref: ${GITHUB_REF}"
            exit 1
          fi

  build-and-sign-dockerhub-image:
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    runs-on: ubuntu-latest
    needs: parse-docker-build-env
    steps:
      - name: "Build and sign Docker images"
        uses: exo-actions/buildDockerImage-action@v1
        with:
          dockerImage: "exoplatform/exo-community"
          dockerImageTag: ${{ needs.parse-docker-build-env.outputs.image_tag }}
          signImage: false
          cosignImage: true
          attestImage: true
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          DOCKER_PRIVATE_KEY_ID: ${{ secrets.DOCKER_PRIVATE_KEY_ID }}
          DOCKER_PRIVATE_KEY: ${{ secrets.DOCKER_PRIVATE_KEY }}
          DOCKER_PRIVATE_KEY_PASSPHRASE: ${{ secrets.DOCKER_PRIVATE_KEY_PASSPHRASE }}
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
